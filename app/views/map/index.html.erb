<%=javascript_include_tag :defaults %>
<script type="text/javascript"
        src="http://maps.google.com/maps/api/js?sensor=true">
</script>
<%= hidden_field_tag "results", @bathrooms_with_address_ratings.to_json %>
<script type="text/javascript" language="javascript">

  var your_city = new google.maps.LatLng(40, 50);
  var map;
  var geocoder = new google.maps.Geocoder();
  var infowindow;
  var results;// = //"<%= @bathrooms_with_address_ratings.to_json %>//"//.replace(/\\/g, "\\");
  //alert(results);
  //results = results.replace(/&quot;/g, "\"");
  //alert(results);
  //results = eval(results);
  //alert(results);
  //var distanceCalc = new google.maps.geometry.Spherical();
  google.maps.event.addDomListener(window, "load", initialize);
  function initialize() {
    var mapOptions = {
      zoom: 15,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      center: your_city
    };
    map = new google.maps.Map(document.getElementById("big_map"),
    mapOptions);
	infowindow = new google.maps.InfoWindow({content:"stuff..."});
	if(document.getElementById("results"))
	{
		results = JSON.parse(document.getElementById("results").value);
		//alert(results[0][2][0].rating.overall);
		markBathrooms(results);
	}
	else
	{
		setTimeout(initialize(), 1000);
	}
  }
  
  function createMarker(lat, lng)
  {
 	var marker = new google.maps.Marker({
	  map:map,
	  draggable:false,
	  animation: google.maps.Animation.DROP,
	  position: new google.maps.LatLng(lat, lng),
	  content: ""
	});
	return marker;
  }
  
  function markBathrooms(results)
  {
    map.setCenter(new google.maps.LatLng(results[0][1].address.latitude, results[0][1].address.longitude));
	for (var i =0; i<results.length; i++)
	{
		var marker = createMarker(results[i][1].address.latitude, results[i][1].address.longitude);
		var info = createInfo(results[i][0].bathroom.title,
								results[i][1].address.inside_location+"\n"+
									results[i][1].address.street_address+"\n"+
									results[i][1].address.city+", "+
									results[i][1].address.state+", "+
									results[i][1].address.country,
								results[i][0].bathroom.description,
								results[i][2][0].rating.overall);
		marker.content = info;
		google.maps.event.addListener(marker, 'click', function() {
			infowindow.setContent(this.content);
			infowindow.open(map, this);
		});
		//marker.setMap(map);
	}
  }
  
  function createInfo(title, address, description, rating)
  {
	var contentString = "<div>"+
							"<h3>"+title+"</h1>"+
							"<p>"+address+"</p>"+
							"<p>"+description+"</p>"+
							"<p>"+rating+"</p>"+
						"</div>";
						
	return contentString;
  }
</script>

<% form_tag map_url, :method => "get" do %>
    <%= text_field_tag :keyword, params[:keyword] %>
    <%= submit_tag "Search"%>
<% end %>

<%= params.inspect %>


<div id="big_map" style="width:920px; height:600px;"></div>
<%= @bathrooms_with_address_ratings.to_json %>